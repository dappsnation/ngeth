var _ERC1193_ethersProvider, _ERC1193_ethersSigner, _ERC1193_wallet, _ERC1193_events;
import { __classPrivateFieldGet, __classPrivateFieldSet } from "tslib";
import { inject, NgZone } from '@angular/core';
import { getAddress } from '@ethersproject/address';
import { toChainId, toChainHex } from '@ngeth/ethers-core';
import { timer, of, combineLatest, defer, BehaviorSubject } from 'rxjs';
import { map, shareReplay, switchMap, filter } from 'rxjs/operators';
import { Web3Provider } from '@ethersproject/providers';
import { fromEthEvent } from '../events';
import { getChain } from '../chain';
import { fromChain } from './utils';
const errorCode = {
    4001: '[User Rejected Request] The user rejected the request.',
    4100: '[Unauthorized] 	The requested method and/or account has not been authorized by the user.',
    4200: '[Unsupported Method]	The Provider does not support the requested method.',
    4900: '[Disconnected] The Provider is disconnected from all chains.',
    4901: '[Chain Disconnected] The Provider is not connected to the requested chain.',
};
function exist(value) {
    return value !== undefined && value !== null;
}
export class ERC1193 {
    constructor() {
        this.zone = inject(NgZone);
        _ERC1193_ethersProvider.set(this, void 0);
        _ERC1193_ethersSigner.set(this, void 0);
        _ERC1193_wallet.set(this, new BehaviorSubject(null));
        _ERC1193_events.set(this, {});
        this.walletChanges = __classPrivateFieldGet(this, _ERC1193_wallet, "f").asObservable();
        /** Observe if current account is connected */
        this.connected$ = this.walletChanges.pipe(filter(exist), switchMap(wallet => {
            return combineLatest([
                this.fromEvent(wallet, 'connect', undefined),
                this.fromEvent(wallet, 'disconnect', undefined),
            ]);
        }), switchMap(() => {
            if (this.provider?.isConnected())
                return of(true);
            return timer(500).pipe(map(() => this.provider?.isConnected()));
        }), shareReplay({ refCount: true, bufferSize: 1 }));
        /**
         * First account connected to the dapp, if any
         * @note This might not be the selected account in Metamask
         */
        this.account$ = this.walletChanges.pipe(switchMap(wallet => wallet ? this.fromEvent(wallet, 'accountsChanged', []) : of(void 0)), switchMap(() => {
            if (this.account)
                return of([this.account]);
            return timer(500).pipe(map(() => (this.account ? [this.account] : [])));
        }), map(accounts => accounts.length ? getAddress(accounts[0]) : undefined), shareReplay({ refCount: true, bufferSize: 1 }));
        /**
         * Current account. Doesn't emit until therer is a connected account
         * @note ⚠️ Only use if you're sure there is an account (inside a guard for example)
         */
        this.currentAccount$ = this.account$.pipe(filter(exist));
        this.chainId$ = this.walletChanges.pipe(switchMap(wallet => wallet ? this.fromEvent(wallet, 'chainChanged', undefined) : of(void 0)), switchMap(() => {
            if (this.chainId)
                return of(this.chainId);
            return timer(500).pipe(map(() => this.chainId));
        }), filter(exist), map(chainId => toChainId(chainId)), shareReplay({ refCount: true, bufferSize: 1 }));
        this.message$ = this.walletChanges.pipe(filter(exist), switchMap(wallet => this.fromEvent(wallet, 'message')));
    }
    get ethersProvider() {
        return __classPrivateFieldGet(this, _ERC1193_ethersProvider, "f");
    }
    get ethersSigner() {
        return __classPrivateFieldGet(this, _ERC1193_ethersSigner, "f");
    }
    /** Listen on event from MetaMask Provider */
    fromEvent(wallet, event, initial) {
        if (!__classPrivateFieldGet(this, _ERC1193_events, "f")[event]) {
            __classPrivateFieldGet(this, _ERC1193_events, "f")[event] = defer(() => {
                return fromEthEvent(wallet.provider, this.zone, event, initial);
            });
        }
        return __classPrivateFieldGet(this, _ERC1193_events, "f")[event];
    }
    /** Select a wallet to setup the provider & signer */
    async selectWallet(wallet) {
        if (!wallet) {
            if (!this.wallets.length)
                throw new Error('No wallet provided or found');
            wallet = await this.getWallet();
            if (!wallet)
                throw new Error('No wallet selected');
        }
        if (wallet.provider !== this.provider) {
            __classPrivateFieldSet(this, _ERC1193_ethersProvider, new Web3Provider(wallet.provider), "f");
            __classPrivateFieldSet(this, _ERC1193_ethersSigner, __classPrivateFieldGet(this, _ERC1193_ethersProvider, "f").getSigner(), "f");
            __classPrivateFieldGet(this, _ERC1193_wallet, "f").next(wallet);
            this.provider = wallet.provider;
        }
    }
    /** Select a wallet and connect to it */
    async enable(wallet) {
        await this.selectWallet(wallet);
        if (!this.provider)
            throw new Error('No provider connected to ERC1193 service');
        return this.provider.request({ method: 'eth_requestAccounts' });
    }
    /**
     * Request user to change chain
     * @note If the error code (error.code) is 4902, then the requested chain has not been added by MetaMask, and you have to request to add it via addChain
     * @param id The 0x-non zero chainId or decimal number
     */
    switchChain(id) {
        const chainId = toChainHex(id);
        return this.provider?.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId }]
        });
    }
    async addChain(chain) {
        const params = (typeof chain === "string")
            ? await getChain(chain).then(fromChain)
            : chain;
        return this.provider?.request({
            method: 'wallet_addEthereumChain',
            params: [params]
        });
    }
    watchAsset(params) {
        return this.provider?.request({
            method: 'wallet_watchAsset',
            params: { type: 'ERC20', options: params }
        });
    }
}
_ERC1193_ethersProvider = new WeakMap(), _ERC1193_ethersSigner = new WeakMap(), _ERC1193_wallet = new WeakMap(), _ERC1193_events = new WeakMap();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL2V0aGVycy9hbmd1bGFyL3NyYy9saWIvZXJjMTE5My9zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDL0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRXBELE9BQU8sRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDM0QsT0FBTyxFQUFFLEtBQUssRUFBYyxFQUFFLEVBQUUsYUFBYSxFQUFFLEtBQUssRUFBRSxlQUFlLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDcEYsT0FBTyxFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JFLE9BQU8sRUFBaUIsWUFBWSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDdkUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN6QyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFHcEMsTUFBTSxTQUFTLEdBQUc7SUFDaEIsSUFBSSxFQUFFLHdEQUF3RDtJQUM5RCxJQUFJLEVBQUUsMEZBQTBGO0lBQ2hHLElBQUksRUFBRSwwRUFBMEU7SUFDaEYsSUFBSSxFQUFFLDhEQUE4RDtJQUNwRSxJQUFJLEVBQUUsNEVBQTRFO0NBQ25GLENBQUE7QUFJRCxTQUFTLEtBQUssQ0FBSSxLQUFnQjtJQUNoQyxPQUFPLEtBQUssS0FBSyxTQUFTLElBQUksS0FBSyxLQUFLLElBQUksQ0FBQztBQUMvQyxDQUFDO0FBR0QsTUFBTSxPQUFnQixPQUFPO0lBQTdCO1FBQ1UsU0FBSSxHQUFHLE1BQU0s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QUFNLE9BQU8sR0FBRyxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDL0IsT0FBTyxJQUFJLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBTztZQUNsQyxNQUFNLEVBQUUsNEJBQTRCO1lBQ3BDLE1BQU0sRUFBRSxDQUFDLEVBQUUsT0FBTyxFQUFFLENBQUM7U0FDdEIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELEtBQUssQ0FBQyxRQUFRLENBQUMsS0FBaUM7UUFDOUMsTUFBTSxNQUFNLEdBQUcsQ0FBQyxPQUFPLEtBQUssS0FBSyxRQUFRLENBQUM7WUFDeEMsQ0FBQyxDQUFDLE1BQU0sUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUM7WUFDdkMsQ0FBQyxDQUFDLEtBQUssQ0FBQztRQUNWLE9BQU8sSUFBSSxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQU87WUFDbEMsTUFBTSxFQUFFLHlCQUF5QjtZQUNqQyxNQUFNLEVBQUUsQ0FBQyxNQUFNLENBQUM7U0FDakIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELFVBQVUsQ0FBQyxNQUFtQztRQUM1QyxPQUFPLElBQUksQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFVO1lBQ3JDLE1BQU0sRUFBRSxtQkFBbUI7WUFDM0IsTUFBTSxFQUFFLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFO1NBQzNDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGluamVjdCwgTmdab25lIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBnZXRBZGRyZXNzIH0gZnJvbSAnQGV0aGVyc3Byb2plY3QvYWRkcmVzcyc7XG5pbXBvcnQgeyBBZGRDaGFpblBhcmFtZXRlciwgRVJDMTE5M0V2ZW50cywgRVJDMTE5M1BhcmFtLCBFUkMxMTkzUHJvdmlkZXIsIFdhbGxldFByb2ZpbGUsIFdhdGNoQXNzZXRQYXJhbXMgfSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB7IHRvQ2hhaW5JZCwgdG9DaGFpbkhleCB9IGZyb20gJ0BuZ2V0aC9ldGhlcnMtY29yZSc7XG5pbXBvcnQgeyB0aW1lciwgT2JzZXJ2YWJsZSwgb2YsIGNvbWJpbmVMYXRlc3QsIGRlZmVyLCBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgc2hhcmVSZXBsYXksIHN3aXRjaE1hcCwgZmlsdGVyIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgSnNvblJwY1NpZ25lciwgV2ViM1Byb3ZpZGVyIH0gZnJvbSAnQGV0aGVyc3Byb2plY3QvcHJvdmlkZXJzJztcbmltcG9ydCB7IGZyb21FdGhFdmVudCB9IGZyb20gJy4uL2V2ZW50cyc7XG5pbXBvcnQgeyBnZXRDaGFpbiB9IGZyb20gJy4uL2NoYWluJztcbmltcG9ydCB7IGZyb21DaGFpbiB9IGZyb20gJy4vdXRpbHMnO1xuXG5cbmNvbnN0IGVycm9yQ29kZSA9IHtcbiAgNDAwMTpcdCdbVXNlciBSZWplY3RlZCBSZXF1ZXN0XSBUaGUgdXNlciByZWplY3RlZCB0aGUgcmVxdWVzdC4nLFxuICA0MTAwOlx0J1tVbmF1dGhvcml6ZWRdIFx0VGhlIHJlcXVlc3RlZCBtZXRob2QgYW5kL29yIGFjY291bnQgaGFzIG5vdCBiZWVuIGF1dGhvcml6ZWQgYnkgdGhlIHVzZXIuJyxcbiAgNDIwMDpcdCdbVW5zdXBwb3J0ZWQgTWV0aG9kXVx0VGhlIFByb3ZpZGVyIGRvZXMgbm90IHN1cHBvcnQgdGhlIHJlcXVlc3RlZCBtZXRob2QuJyxcbiAgNDkwMDpcdCdbRGlzY29ubmVjdGVkXSBUaGUgUHJvdmlkZXIgaXMgZGlzY29ubmVjdGVkIGZyb20gYWxsIGNoYWlucy4nLFxuICA0OTAxOlx0J1tDaGFpbiBEaXNjb25uZWN0ZWRdIFRoZSBQcm92aWRlciBpcyBub3QgY29ubmVjdGVkIHRvIHRoZSByZXF1ZXN0ZWQgY2hhaW4uJyxcbn1cblxuXG5cbmZ1bmN0aW9uIGV4aXN0PFQ+KHZhbHVlPzogVCB8IG51bGwpOiB2YWx1ZSBpcyBUIHtcbiAgcmV0dXJuIHZhbHVlICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgIT09IG51bGw7XG59XG5cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEVSQzExOTM8V2FsbGV0IGV4dGVuZHMgV2FsbGV0UHJvZmlsZSA9IFdhbGxldFByb2ZpbGU+IHtcbiAgcHJpdmF0ZSB6b25lID0gaW5qZWN0KE5nWm9uZSk7XG4gICNldGhlcnNQcm92aWRlcj86IFdlYjNQcm92aWRlcjtcbiAgI2V0aGVyc1NpZ25lcj86IEpzb25ScGNTaWduZXI7XG4gICN3YWxsZXQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFdhbGxldCB8IG51bGw+KG51bGwpO1xuICAjZXZlbnRzOiBSZWNvcmQ8c3RyaW5nLCBPYnNlcnZhYmxlPHVua25vd24+PiA9IHt9O1xuXG4gIHdhbGxldENoYW5nZXMgPSB0aGlzLiN3YWxsZXQuYXNPYnNlcnZhYmxlKCk7XG4gIFxuICBwcm90ZWN0ZWQgcHJvdmlkZXI/OiBFUkMxMTkzUHJvdmlkZXI7XG4gIGFic3RyYWN0IGFjY291bnQ/OiBzdHJpbmc7XG4gIGFic3RyYWN0IGNoYWluSWQ/OiBudW1iZXI7XG4gIGFic3RyYWN0IHdhbGxldHM6IFdhbGxldFtdO1xuICAvKiogTWV0aG9kIHVzZWQgdG8gYXNrIHRoZSB1c2VyIHdoaWNoIHdhbGxldCB0byBzZWxlY3QgaWYgbXVsdGlwbGUgd2FsbGV0IGF2YWlsYWJsZSAqL1xuICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0V2FsbGV0KCk6IFByb21pc2U8V2FsbGV0IHwgdW5kZWZpbmVkPjtcblxuICAvKiogT2JzZXJ2ZSBpZiBjdXJyZW50IGFjY291bnQgaXMgY29ubmVjdGVkICovXG4gIGNvbm5lY3RlZCQgPSB0aGlzLndhbGxldENoYW5nZXMucGlwZShcbiAgICBmaWx0ZXIoZXhpc3QpLFxuICAgIHN3aXRjaE1hcCh3YWxsZXQgPT4ge1xuICAgICAgcmV0dXJuIGNvbWJpbmVMYXRlc3QoW1xuICAgICAgICB0aGlzLmZyb21FdmVudCh3YWxsZXQsICdjb25uZWN0JywgdW5kZWZpbmVkKSxcbiAgICAgICAgdGhpcy5mcm9tRXZlbnQod2FsbGV0LCAnZGlzY29ubmVjdCcsIHVuZGVmaW5lZCksXG4gICAgICBdKVxuICAgIH0pLFxuICAgIHN3aXRjaE1hcCgoKSA9PiB7XG4gICAgICBpZiAodGhpcy5wcm92aWRlcj8uaXNDb25uZWN0ZWQoKSkgcmV0dXJuIG9mKHRydWUpO1xuICAgICAgcmV0dXJuIHRpbWVyKDUwMCkucGlwZShtYXAoKCkgPT4gdGhpcy5wcm92aWRlcj8uaXNDb25uZWN0ZWQoKSkpXG4gICAgfSksXG4gICAgc2hhcmVSZXBsYXkoeyByZWZDb3VudDogdHJ1ZSwgYnVmZmVyU2l6ZTogMSB9KVxuICApO1xuICAgIFxuICAvKipcbiAgICogRmlyc3QgYWNjb3VudCBjb25uZWN0ZWQgdG8gdGhlIGRhcHAsIGlmIGFueVxuICAgKiBAbm90ZSBUaGlzIG1pZ2h0IG5vdCBiZSB0aGUgc2VsZWN0ZWQgYWNjb3VudCBpbiBNZXRhbWFza1xuICAgKi9cbiAgYWNjb3VudCQgPSB0aGlzLndhbGxldENoYW5nZXMucGlwZShcbiAgICBzd2l0Y2hNYXAod2FsbGV0ID0+IHdhbGxldCA/IHRoaXMuZnJvbUV2ZW50KHdhbGxldCwgJ2FjY291bnRzQ2hhbmdlZCcsIFtdKSA6IG9mKHZvaWQgMCkpLFxuICAgIHN3aXRjaE1hcCgoKSA9PiB7XG4gICAgICBpZiAodGhpcy5hY2NvdW50KSByZXR1cm4gb2YoW3RoaXMuYWNjb3VudF0pO1xuICAgICAgcmV0dXJuIHRpbWVyKDUwMCkucGlwZShtYXAoKCkgPT4gKHRoaXMuYWNjb3VudCA/IFt0aGlzLmFjY291bnRdIDogW10pKSk7XG4gICAgfSksXG4gICAgbWFwKGFjY291bnRzID0+IGFjY291bnRzLmxlbmd0aCA/IGdldEFkZHJlc3MoYWNjb3VudHNbMF0pIDogdW5kZWZpbmVkKSxcbiAgICBzaGFyZVJlcGxheSh7IHJlZkNvdW50OiB0cnVlLCBidWZmZXJTaXplOiAxIH0pXG4gICk7XG5cbiAgLyoqIFxuICAgKiBDdXJyZW50IGFjY291bnQuIERvZXNuJ3QgZW1pdCB1bnRpbCB0aGVyZXIgaXMgYSBjb25uZWN0ZWQgYWNjb3VudFxuICAgKiBAbm90ZSDimqDvuI8gT25seSB1c2UgaWYgeW91J3JlIHN1cmUgdGhlcmUgaXMgYW4gYWNjb3VudCAoaW5zaWRlIGEgZ3VhcmQgZm9yIGV4YW1wbGUpXG4gICAqL1xuICBjdXJyZW50QWNjb3VudCQgPSB0aGlzLmFjY291bnQkLnBpcGUoZmlsdGVyKGV4aXN0KSk7XG5cbiAgY2hhaW5JZCQgPSB0aGlzLndhbGxldENoYW5nZXMucGlwZShcbiAgICBzd2l0Y2hNYXAod2FsbGV0ID0+IHdhbGxldCA/IHRoaXMuZnJvbUV2ZW50KHdhbGxldCwgJ2NoYWluQ2hhbmdlZCcsIHVuZGVmaW5lZCkgOiBvZih2b2lkIDApKSxcbiAgICBzd2l0Y2hNYXAoKCkgPT4ge1xuICAgICAgaWYgKHRoaXMuY2hhaW5JZCkgcmV0dXJuIG9mKHRoaXMuY2hhaW5JZCk7XG4gICAgICByZXR1cm4gdGltZXIoNTAwKS5waXBlKG1hcCgoKSA9PiB0aGlzLmNoYWluSWQpKVxuICAgIH0pLFxuICAgIGZpbHRlcihleGlzdCksXG4gICAgbWFwKGNoYWluSWQgPT4gdG9DaGFpbklkKGNoYWluSWQpKSxcbiAgICBzaGFyZVJlcGxheSh7IHJlZkNvdW50OiB0cnVlLCBidWZmZXJTaXplOiAxIH0pXG4gICk7XG5cbiAgbWVzc2FnZSQgPSB0aGlzLndhbGxldENoYW5nZXMucGlwZShcbiAgICBmaWx0ZXIoZXhpc3QpLFxuICAgIHN3aXRjaE1hcCh3YWxsZXQgPT4gdGhpcy5mcm9tRXZlbnQod2FsbGV0LCAnbWVzc2FnZScpKSxcbiAgKTtcblxuICBnZXQgZXRoZXJzUHJvdmlkZXIoKSB7XG4gICAgcmV0dXJuIHRoaXMuI2V0aGVyc1Byb3ZpZGVyO1xuICB9XG5cbiAgZ2V0IGV0aGVyc1NpZ25lcigpIHtcbiAgICByZXR1cm4gdGhpcy4jZXRoZXJzU2lnbmVyO1xuICB9XG5cbiAgLyoqIExpc3RlbiBvbiBldmVudCBmcm9tIE1ldGFNYXNrIFByb3ZpZGVyICovXG4gIHByb3RlY3RlZCBmcm9tRXZlbnQ8SyBleHRlbmRzIGtleW9mIEVSQzExOTNFdmVudHM+KFxuICAgIHdhbGxldDogV2FsbGV0LFxuICAgIGV2ZW50OiBLLFxuICAgIGluaXRpYWw/OiBFUkMxMTkzUGFyYW08Sz5cbiAgKTogT2JzZXJ2YWJsZTxFUkMxMTkzUGFyYW08Sz4+IHtcbiAgICBpZiAoIXRoaXMuI2V2ZW50c1tldmVudF0pIHtcbiAgICAgIHRoaXMuI2V2ZW50c1tldmVudF0gPSBkZWZlcigoKSA9PiB7XG4gICAgICAgIHJldHVybiBmcm9tRXRoRXZlbnQ8RVJDMTE5M1BhcmFtPEs+Pih3YWxsZXQucHJvdmlkZXIsIHRoaXMuem9uZSwgZXZlbnQsIGluaXRpYWwpO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLiNldmVudHNbZXZlbnRdIGFzIE9ic2VydmFibGU8RVJDMTE5M1BhcmFtPEs+PjtcbiAgfVxuXG4gIC8qKiBTZWxlY3QgYSB3YWxsZXQgdG8gc2V0dXAgdGhlIHByb3ZpZGVyICYgc2lnbmVyICovXG4gIGFzeW5jIHNlbGVjdFdhbGxldCh3YWxsZXQ/OiBXYWxsZXQpIHtcbiAgICBpZiAoIXdhbGxldCkge1xuICAgICAgaWYgKCF0aGlzLndhbGxldHMubGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ05vIHdhbGxldCBwcm92aWRlZCBvciBmb3VuZCcpO1xuICAgICAgd2FsbGV0ID0gYXdhaXQgdGhpcy5nZXRXYWxsZXQoKTtcbiAgICAgIGlmICghd2FsbGV0KSB0aHJvdyBuZXcgRXJyb3IoJ05vIHdhbGxldCBzZWxlY3RlZCcpO1xuICAgIH1cbiAgICBpZiAod2FsbGV0LnByb3ZpZGVyICE9PSB0aGlzLnByb3ZpZGVyKSB7XG4gICAgICB0aGlzLiNldGhlcnNQcm92aWRlciA9IG5ldyBXZWIzUHJvdmlkZXIod2FsbGV0LnByb3ZpZGVyKTtcbiAgICAgIHRoaXMuI2V0aGVyc1NpZ25lciA9IHRoaXMuI2V0aGVyc1Byb3ZpZGVyLmdldFNpZ25lcigpO1xuICAgICAgdGhpcy4jd2FsbGV0Lm5leHQod2FsbGV0KTtcbiAgICAgIHRoaXMucHJvdmlkZXIgPSB3YWxsZXQucHJvdmlkZXI7XG4gICAgfVxuICB9XG5cbiAgLyoqIFNlbGVjdCBhIHdhbGxldCBhbmQgY29ubmVjdCB0byBpdCAqL1xuICBhc3luYyBlbmFibGUod2FsbGV0PzogV2FsbGV0KTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGF3YWl0IHRoaXMuc2VsZWN0V2FsbGV0KHdhbGxldCk7XG4gICAgaWYgKCF0aGlzLnByb3ZpZGVyKSB0aHJvdyBuZXcgRXJyb3IoJ05vIHByb3ZpZGVyIGNvbm5lY3RlZCB0byBFUkMxMTkzIHNlcnZpY2UnKTtcbiAgICByZXR1cm4gdGhpcy5wcm92aWRlci5yZXF1ZXN0KHsgbWV0aG9kOiAnZXRoX3JlcXVlc3RBY2NvdW50cycgfSk7XG4gIH1cblxuICAvKipcbiAgICogUmVxdWVzdCB1c2VyIHRvIGNoYW5nZSBjaGFpblxuICAgKiBAbm90ZSBJZiB0aGUgZXJyb3IgY29kZSAoZXJyb3IuY29kZSkgaXMgNDkwMiwgdGhlbiB0aGUgcmVxdWVzdGVkIGNoYWluIGhhcyBub3QgYmVlbiBhZGRlZCBieSBNZXRhTWFzaywgYW5kIHlvdSBoYXZlIHRvIHJlcXVlc3QgdG8gYWRkIGl0IHZpYSBhZGRDaGFpblxuICAgKiBAcGFyYW0gaWQgVGhlIDB4LW5vbiB6ZXJvIGNoYWluSWQgb3IgZGVjaW1hbCBudW1iZXJcbiAgICovXG4gIHN3aXRjaENoYWluKGlkOiBzdHJpbmcgfCBudW1iZXIpIHtcbiAgICBjb25zdCBjaGFpbklkID0gdG9DaGFpbkhleChpZCk7XG4gICAgcmV0dXJuIHRoaXMucHJvdmlkZXI/LnJlcXVlc3Q8bnVsbD4oe1xuICAgICAgbWV0aG9kOiAnd2FsbGV0X3N3aXRjaEV0aGVyZXVtQ2hhaW4nLFxuICAgICAgcGFyYW1zOiBbeyBjaGFpbklkIH1dXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBhZGRDaGFpbihjaGFpbjogQWRkQ2hhaW5QYXJhbWV0ZXIgfCBzdHJpbmcpIHtcbiAgICBjb25zdCBwYXJhbXMgPSAodHlwZW9mIGNoYWluID09PSBcInN0cmluZ1wiKVxuICAgICAgPyBhd2FpdCBnZXRDaGFpbihjaGFpbikudGhlbihmcm9tQ2hhaW4pXG4gICAgICA6IGNoYWluO1xuICAgIHJldHVybiB0aGlzLnByb3ZpZGVyPy5yZXF1ZXN0PG51bGw+KHtcbiAgICAgIG1ldGhvZDogJ3dhbGxldF9hZGRFdGhlcmV1bUNoYWluJyxcbiAgICAgIHBhcmFtczogW3BhcmFtc11cbiAgICB9KTtcbiAgfVxuXG4gIHdhdGNoQXNzZXQocGFyYW1zOiBXYXRjaEFzc2V0UGFyYW1zWydvcHRpb25zJ10pIHtcbiAgICByZXR1cm4gdGhpcy5wcm92aWRlcj8ucmVxdWVzdDxib29sZWFuPih7XG4gICAgICBtZXRob2Q6ICd3YWxsZXRfd2F0Y2hBc3NldCcsXG4gICAgICBwYXJhbXM6IHsgdHlwZTogJ0VSQzIwJywgb3B0aW9uczogcGFyYW1zIH1cbiAgICB9KTtcbiAgfVxufVxuIl19