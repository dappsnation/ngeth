import { EthersContract } from '@ngeth/ethers-core';
import { shareReplay, map, from, scan, startWith, combineLatest, finalize } from 'rxjs';
import { fromEthEvent } from './events';
import { inject, NgZone } from '@angular/core';
function getEventTag(filter) {
    const emptyTopics = !filter.topics || !filter.topics.length;
    if (filter.address && emptyTopics)
        return '*';
    const address = filter.address ?? '*';
    const topics = (filter.topics ?? []).map((topic) => Array.isArray(topic) ? topic.join('|') : topic);
    return `${address}:${topics}`;
}
function flattenEvents(events) {
    const record = {};
    for (const event of events) {
        record[event.transactionHash] = event;
    }
    return Object.values(record);
}
export class NgContract extends EthersContract {
    constructor(address, abi, signer, ngZone) {
        super(address, abi, signer);
        this._events = {};
        this.ngZone = ngZone ?? inject(NgZone);
    }
    /** Transform event name into an EventFilter */
    getEventFilter(name) {
        if (name === 'error')
            throw new Error('"error" event is not implemented yet');
        if (name === 'event')
            throw new Error('"event" event is not implemented yet');
        if (name === '*')
            throw new Error('"*" event is not implemented yet');
        const fragment = this.interface.getEvent(name);
        const topic = this.interface.getEventTopic(fragment);
        return { address: this.address, topics: [topic] };
    }
    wrapEvent(log) {
        const { name, signature, args, eventFragment } = this.interface.parseLog(log);
        return {
            ...log,
            getBlock: () => this.provider.getBlock(log.blockHash),
            getTransaction: () => this.provider.getTransaction(log.transactionHash),
            getTransactionReceipt: () => this.provider.getTransactionReceipt(log.transactionHash),
            decode: (data, topics) => {
                return this.interface.decodeEventLog(eventFragment, data, topics);
            },
            event: name,
            eventSignature: signature,
            args: args
        };
    }
    /**
     * Listen on the changes of an event, starting with the current state
     * @param event The event filter
     */
    from(event) {
        if (!this.provider)
            throw new Error('Provider required for event');
        const eventFilter = typeof event === 'string'
            ? this.getEventFilter(event)
            : event;
        const topic = eventFilter.topics?.[0];
        if (typeof topic !== 'string')
            throw new Error('Invalid topic');
        const tag = getEventTag(eventFilter);
        if (!this._events[tag]) {
            const initial = this.queryFilter(eventFilter);
            const listener = fromEthEvent(this.provider, this.ngZone, eventFilter).pipe(map(log => this.wrapEvent(log)), scan((acc, value) => acc.concat(value), []), startWith([]));
            this._events[tag] = combineLatest([
                from(initial),
                listener,
            ]).pipe(map(([events, last]) => [...events, ...last]), map(flattenEvents), // remove duplicated (events seems to have a cache of 2 somehow...)
            finalize(() => delete this._events[tag]), // remove cache when no subscriber remains
            shareReplay({ refCount: true, bufferSize: 1 }));
        }
        return this._events[tag];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJhY3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9ldGhlcnMvYW5ndWxhci9zcmMvbGliL2NvbnRyYWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBa0IsY0FBYyxFQUEyQixNQUFNLG9CQUFvQixDQUFDO0FBRzdGLE9BQU8sRUFBYyxXQUFXLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLGFBQWEsRUFBRSxRQUFRLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDcEcsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUN4QyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQU8vQyxTQUFTLFdBQVcsQ0FBQyxNQUFtQjtJQUN0QyxNQUFNLFdBQVcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQztJQUM1RCxJQUFJLE1BQU0sQ0FBQyxPQUFPLElBQUksV0FBVztRQUFFLE9BQU8sR0FBRyxDQUFDO0lBRTlDLE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxPQUFPLElBQUksR0FBRyxDQUFDO0lBQ3RDLE1BQU0sTUFBTSxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUNqRCxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQy9DLENBQUM7SUFDRixPQUFPLEdBQUcsT0FBTyxJQUFJLE1BQU0sRUFBRSxDQUFDO0FBQ2hDLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FBQyxNQUFlO0lBQ3BDLE1BQU0sTUFBTSxHQUEwQixFQUFFLENB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QUMsR0FBRyxDQUFDLENBQUM7SUFDM0IsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29udHJhY3RFdmVudHMsIEV0aGVyc0NvbnRyYWN0LCBUeXBlZEV2ZW50LCBUeXBlZEZpbHRlciB9IGZyb20gJ0BuZ2V0aC9ldGhlcnMtY29yZSc7XHJcbmltcG9ydCB7IEV2ZW50RmlsdGVyLCBDb250cmFjdEludGVyZmFjZSB9IGZyb20gJ0BldGhlcnNwcm9qZWN0L2NvbnRyYWN0cyc7XHJcbmltcG9ydCB7IExvZyB9IGZyb20gJ0BldGhlcnNwcm9qZWN0L2Fic3RyYWN0LXByb3ZpZGVyJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgc2hhcmVSZXBsYXksIG1hcCwgZnJvbSwgc2Nhbiwgc3RhcnRXaXRoLCBjb21iaW5lTGF0ZXN0LCBmaW5hbGl6ZSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBmcm9tRXRoRXZlbnQgfSBmcm9tICcuL2V2ZW50cyc7XHJcbmltcG9ydCB7IGluamVjdCwgTmdab25lIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcblxyXG5pbXBvcnQgdHlwZSB7IFNpZ25lciB9IGZyb20gJ0BldGhlcnNwcm9qZWN0L2Fic3RyYWN0LXNpZ25lcic7XHJcbmltcG9ydCB0eXBlIHsgRXZlbnQgfSBmcm9tICdAZXRoZXJzcHJvamVjdC9jb250cmFjdHMnO1xyXG5pbXBvcnQgdHlwZSB7IFByb3ZpZGVyIH0gZnJvbSBcIkBldGhlcnNwcm9qZWN0L3Byb3ZpZGVyc1wiO1xyXG5pbXBvcnQgdHlwZSB7IEJ5dGVzTGlrZSB9IGZyb20gJ0BldGhlcnNwcm9qZWN0L2J5dGVzJztcclxuXHJcbmZ1bmN0aW9uIGdldEV2ZW50VGFnKGZpbHRlcjogRXZlbnRGaWx0ZXIpOiBzdHJpbmcge1xyXG4gIGNvbnN0IGVtcHR5VG9waWNzID0gIWZpbHRlci50b3BpY3MgfHwgIWZpbHRlci50b3BpY3MubGVuZ3RoO1xyXG4gIGlmIChmaWx0ZXIuYWRkcmVzcyAmJiBlbXB0eVRvcGljcykgcmV0dXJuICcqJztcclxuXHJcbiAgY29uc3QgYWRkcmVzcyA9IGZpbHRlci5hZGRyZXNzID8/ICcqJztcclxuICBjb25zdCB0b3BpY3MgPSAoZmlsdGVyLnRvcGljcyA/PyBbXSkubWFwKCh0b3BpYykgPT5cclxuICAgIEFycmF5LmlzQXJyYXkodG9waWMpID8gdG9waWMuam9pbignfCcpIDogdG9waWNcclxuICApO1xyXG4gIHJldHVybiBgJHthZGRyZXNzfToke3RvcGljc31gO1xyXG59XHJcblxyXG5mdW5jdGlvbiBmbGF0dGVuRXZlbnRzKGV2ZW50czogRXZlbnRbXSkge1xyXG4gIGNvbnN0IHJlY29yZDogUmVjb3JkPHN0cmluZywgRXZlbnQ+ID0ge307XHJcbiAgZm9yIChjb25zdCBldmVudCBvZiBldmVudHMpIHtcclxuICAgIHJlY29yZFtldmVudC50cmFuc2FjdGlvbkhhc2hdID0gZXZlbnQ7XHJcbiAgfVxyXG4gIHJldHVybiBPYmplY3QudmFsdWVzKHJlY29yZCk7XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBOZ0NvbnRyYWN0PFxyXG4gIEV2ZW50cyBleHRlbmRzIENvbnRyYWN0RXZlbnRzPEV2ZW50S2V5cywgRmlsdGVyS2V5cz4sXHJcbiAgRXZlbnRLZXlzIGV4dGVuZHMgRXh0cmFjdDxrZXlvZiBFdmVudHNbJ2V2ZW50cyddLCBzdHJpbmc+ID0gRXh0cmFjdDxrZXlvZiBFdmVudHNbJ2V2ZW50cyddLCBzdHJpbmc+LFxyXG4gIEZpbHRlcktleXMgZXh0ZW5kcyBFeHRyYWN0PGtleW9mIEV2ZW50c1snZmlsdGVycyddLCBzdHJpbmc+ID0gRXh0cmFjdDxrZXlvZiBFdmVudHNbJ2ZpbHRlcnMnXSwgc3RyaW5nPixcclxuPiBleHRlbmRzIEV0aGVyc0NvbnRyYWN0PEV2ZW50cywgRXZlbnRLZXlzLCBGaWx0ZXJLZXlzPiB7ICBcclxuXHJcbiAgcHJpdmF0ZSBuZ1pvbmU6IE5nWm9uZTtcclxuICBwcml2YXRlIF9ldmVudHM6IFJlY29yZDxzdHJpbmcsIE9ic2VydmFibGU8YW55Pj4gPSB7fTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBhZGRyZXNzOiBzdHJpbmcsXHJcbiAgICBhYmk6IENvbnRyYWN0SW50ZXJmYWNlLFxyXG4gICAgc2lnbmVyPzogUHJvdmlkZXIgfCBTaWduZXIsXHJcbiAgICBuZ1pvbmU/OiBOZ1pvbmUsXHJcbiAgKSB7XHJcbiAgICBzdXBlcihhZGRyZXNzLCBhYmksIHNpZ25lcik7XHJcbiAgICB0aGlzLm5nWm9uZSA9IG5nWm9uZSA/PyBpbmplY3QoTmdab25lKTtcclxuICB9XHJcblxyXG4gIC8qKiBUcmFuc2Zvcm0gZXZlbnQgbmFtZSBpbnRvIGFuIEV2ZW50RmlsdGVyICovXHJcbiAgcHJpdmF0ZSBnZXRFdmVudEZpbHRlcihuYW1lOiBzdHJpbmcpOiBFdmVudEZpbHRlciB7XHJcbiAgICBpZiAobmFtZSA9PT0gJ2Vycm9yJylcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdcImVycm9yXCIgZXZlbnQgaXMgbm90IGltcGxlbWVudGVkIHlldCcpO1xyXG4gICAgaWYgKG5hbWUgPT09ICdldmVudCcpXHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignXCJldmVudFwiIGV2ZW50IGlzIG5vdCBpbXBsZW1lbnRlZCB5ZXQnKTtcclxuICAgIGlmIChuYW1lID09PSAnKicpIHRocm93IG5ldyBFcnJvcignXCIqXCIgZXZlbnQgaXMgbm90IGltcGxlbWVudGVkIHlldCcpO1xyXG4gICAgY29uc3QgZnJhZ21lbnQgPSB0aGlzLmludGVyZmFjZS5nZXRFdmVudChuYW1lKTtcclxuICAgIGNvbnN0IHRvcGljID0gdGhpcy5pbnRlcmZhY2UuZ2V0RXZlbnRUb3BpYyhmcmFnbWVudCk7XHJcbiAgICByZXR1cm4geyBhZGRyZXNzOiB0aGlzLmFkZHJlc3MsIHRvcGljczogW3RvcGljXSB9O1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB3cmFwRXZlbnQobG9nOiBMb2cpOiBUeXBlZEV2ZW50PEV2ZW50cywgRmlsdGVyS2V5cz4ge1xyXG4gICAgY29uc3QgeyBuYW1lLCBzaWduYXR1cmUsIGFyZ3MsIGV2ZW50RnJhZ21lbnQgfSA9IHRoaXMuaW50ZXJmYWNlLnBhcnNlTG9nKGxvZyk7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAuLi5sb2csXHJcbiAgICAgIGdldEJsb2NrOiAoKSA9PiB0aGlzLnByb3ZpZGVyLmdldEJsb2NrKGxvZy5ibG9ja0hhc2gpLFxyXG4gICAgICBnZXRUcmFuc2FjdGlvbjogKCkgPT4gdGhpcy5wcm92aWRlci5nZXRUcmFuc2FjdGlvbihsb2cudHJhbnNhY3Rpb25IYXNoKSxcclxuICAgICAgZ2V0VHJhbnNhY3Rpb25SZWNlaXB0OiAoKSA9PiB0aGlzLnByb3ZpZGVyLmdldFRyYW5zYWN0aW9uUmVjZWlwdChsb2cudHJhbnNhY3Rpb25IYXNoKSxcclxuICAgICAgZGVjb2RlOiAoZGF0YTogQnl0ZXNMaWtlLCB0b3BpY3M/OiBBcnJheTxzdHJpbmc+KSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaW50ZXJmYWNlLmRlY29kZUV2ZW50TG9nKGV2ZW50RnJhZ21lbnQsIGRhdGEsIHRvcGljcyk7XHJcbiAgICAgIH0sXHJcbiAgICAgIGV2ZW50OiBuYW1lLFxyXG4gICAgICBldmVudFNpZ25hdHVyZTogc2lnbmF0dXJlLFxyXG4gICAgICBhcmdzOiBhcmdzXHJcbiAgICB9IGFzIFR5cGVkRXZlbnQ8RXZlbnRzLCBGaWx0ZXJLZXlzPlxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogTGlzdGVuIG9uIHRoZSBjaGFuZ2VzIG9mIGFuIGV2ZW50LCBzdGFydGluZyB3aXRoIHRoZSBjdXJyZW50IHN0YXRlXHJcbiAgICogQHBhcmFtIGV2ZW50IFRoZSBldmVudCBmaWx0ZXJcclxuICAgKi9cclxuICBmcm9tPEsgZXh0ZW5kcyBGaWx0ZXJLZXlzPihldmVudDogVHlwZWRGaWx0ZXI8Sz4gfCBLKTogT2JzZXJ2YWJsZTxUeXBlZEV2ZW50PEV2ZW50cywgSz5bXT4ge1xyXG4gICAgaWYgKCF0aGlzLnByb3ZpZGVyKSB0aHJvdyBuZXcgRXJyb3IoJ1Byb3ZpZGVyIHJlcXVpcmVkIGZvciBldmVudCcpO1xyXG4gICAgY29uc3QgZXZlbnRGaWx0ZXIgPSB0eXBlb2YgZXZlbnQgPT09ICdzdHJpbmcnXHJcbiAgICAgID8gdGhpcy5nZXRFdmVudEZpbHRlcihldmVudClcclxuICAgICAgOiBldmVudDtcclxuICAgIGNvbnN0IHRvcGljID0gZXZlbnRGaWx0ZXIudG9waWNzPy5bMF07XHJcbiAgICBpZiAodHlwZW9mIHRvcGljICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHRvcGljJyk7XHJcblxyXG4gICAgY29uc3QgdGFnID0gZ2V0RXZlbnRUYWcoZXZlbnRGaWx0ZXIpO1xyXG4gICAgaWYgKCF0aGlzLl9ldmVudHNbdGFnXSkge1xyXG4gICAgICBjb25zdCBpbml0aWFsID0gdGhpcy5xdWVyeUZpbHRlcihldmVudEZpbHRlcik7XHJcbiAgICAgIGNvbnN0IGxpc3RlbmVyID0gZnJvbUV0aEV2ZW50PExvZz4oXHJcbiAgICAgICAgdGhpcy5wcm92aWRlcixcclxuICAgICAgICB0aGlzLm5nWm9uZSxcclxuICAgICAgICBldmVudEZpbHRlclxyXG4gICAgICApLnBpcGUoXHJcbiAgICAgICAgbWFwKGxvZyA9PiB0aGlzLndyYXBFdmVudChsb2cpKSxcclxuICAgICAgICBzY2FuKChhY2MsIHZhbHVlKSA9PiBhY2MuY29uY2F0KHZhbHVlKSwgW10gYXMgVHlwZWRFdmVudDxFdmVudHMsIEZpbHRlcktleXM+W10pLFxyXG4gICAgICAgIHN0YXJ0V2l0aChbXSBhcyBUeXBlZEV2ZW50PEV2ZW50cywgRmlsdGVyS2V5cz5bXSlcclxuICAgICAgKTtcclxuXHJcbiAgICAgIHRoaXMuX2V2ZW50c1t0YWddID0gY29tYmluZUxhdGVzdChbXHJcbiAgICAgICAgZnJvbShpbml0aWFsKSxcclxuICAgICAgICBsaXN0ZW5lcixcclxuICAgICAgXSkucGlwZShcclxuICAgICAgICBtYXAoKFtldmVudHMsIGxhc3RdKSA9PiBbLi4uZXZlbnRzLCAuLi5sYXN0XSksXHJcbiAgICAgICAgbWFwKGZsYXR0ZW5FdmVudHMpLCAvLyByZW1vdmUgZHVwbGljYXRlZCAoZXZlbnRzIHNlZW1zIHRvIGhhdmUgYSBjYWNoZSBvZiAyIHNvbWVob3cuLi4pXHJcbiAgICAgICAgZmluYWxpemUoKCkgPT4gZGVsZXRlIHRoaXMuX2V2ZW50c1t0YWddKSwgLy8gcmVtb3ZlIGNhY2hlIHdoZW4gbm8gc3Vic2NyaWJlciByZW1haW5zXHJcbiAgICAgICAgc2hhcmVSZXBsYXkoeyByZWZDb3VudDogdHJ1ZSwgYnVmZmVyU2l6ZTogMSB9KSxcclxuICAgICAgKTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLl9ldmVudHNbdGFnXTtcclxuICB9XHJcbn1cclxuIl19