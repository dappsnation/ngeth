import { EthersContract } from '@ngeth/ethers-core';
import { shareReplay, map, from, scan, startWith, combineLatest, finalize } from 'rxjs';
import { fromEthEvent } from './events';
import { inject, NgZone } from '@angular/core';
function getEventTag(filter) {
    const emptyTopics = !filter.topics || !filter.topics.length;
    if (filter.address && emptyTopics)
        return '*';
    const address = filter.address ?? '*';
    const topics = (filter.topics ?? []).map((topic) => Array.isArray(topic) ? topic.join('|') : topic);
    return `${address}:${topics}`;
}
function flattenEvents(events) {
    const record = {};
    for (const event of events) {
        record[event.transactionHash] = event;
    }
    return Object.values(record);
}
export class NgContract extends EthersContract {
    constructor(address, abi, signer, ngZone) {
        super(address, abi, signer);
        this._events = {};
        this.ngZone = ngZone ?? inject(NgZone);
    }
    /** Transform event name into an EventFilter */
    getEventFilter(name) {
        if (name === 'error')
            throw new Error('"error" event is not implemented yet');
        if (name === 'event')
            throw new Error('"event" event is not implemented yet');
        if (name === '*')
            throw new Error('"*" event is not implemented yet');
        const fragment = this.interface.getEvent(name);
        const topic = this.interface.getEventTopic(fragment);
        return { address: this.address, topics: [topic] };
    }
    wrapEvent(log) {
        const { name, signature, args, eventFragment } = this.interface.parseLog(log);
        return {
            ...log,
            getBlock: () => this.provider.getBlock(log.blockHash),
            getTransaction: () => this.provider.getTransaction(log.transactionHash),
            getTransactionReceipt: () => this.provider.getTransactionReceipt(log.transactionHash),
            decode: (data, topics) => {
                return this.interface.decodeEventLog(eventFragment, data, topics);
            },
            event: name,
            eventSignature: signature,
            args: args
        };
    }
    /**
     * Listen on the changes of an event, starting with the current state
     * @param event The event filter
     */
    from(event) {
        if (!this.provider)
            throw new Error('Provider required for event');
        const eventFilter = typeof event === 'string'
            ? this.getEventFilter(event)
            : event;
        const topic = eventFilter.topics?.[0];
        if (typeof topic !== 'string')
            throw new Error('Invalid topic');
        const tag = getEventTag(eventFilter);
        if (!this._events[tag]) {
            const initial = this.queryFilter(eventFilter);
            const listener = fromEthEvent(this.provider, this.ngZone, eventFilter).pipe(map(log => this.wrapEvent(log)), scan((acc, value) => acc.concat(value), []), startWith([]));
            this._events[tag] = combineLatest([
                from(initial),
                listener,
            ]).pipe(map(([events, last]) => [...events, ...last]), map(flattenEvents), // remove duplicated (events seems to have a cache of 2 somehow...)
            finalize(() => delete this._events[tag]), // remove cache when no subscriber remains
            shareReplay({ refCount: true, bufferSize: 1 }));
        }
        return this._events[tag];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJhY3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9ldGhlcnMvYW5ndWxhci9zcmMvbGliL2NvbnRyYWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBa0IsY0FBYyxFQUEyQixNQUFNLG9CQUFvQixDQUFDO0FBRzdGLE9BQU8sRUFBYyxXQUFXLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLGFBQWEsRUFBRSxRQUFRLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDcEcsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUN4QyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQU8vQyxTQUFTLFdBQVcsQ0FBQyxNQUFtQjtJQUN0QyxNQUFNLFdBQVcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQztJQUM1RCxJQUFJLE1BQU0sQ0FBQyxPQUFPLElBQUksV0FBVztRQUFFLE9BQU8sR0FBRyxDQUFDO0lBRTlDLE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxPQUFPLElBQUksR0FBRyxDQUFDO0lBQ3RDLE1BQU0sTUFBTSxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUNqRCxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQy9DLENBQUM7SUFDRixPQUFPLEdBQUcsT0FBTyxJQUFJLE1BQU0sRUFBRSxDQUFDO0FBQ2hDLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FBQyxNQUFlO0lBQ3BDLE1BQU0sTUFBTSxHQUEwQixFQUFFLENB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QUMsR0FBRyxDQUFDLENBQUM7SUFDM0IsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29udHJhY3RFdmVudHMsIEV0aGVyc0NvbnRyYWN0LCBUeXBlZEV2ZW50LCBUeXBlZEZpbHRlciB9IGZyb20gJ0BuZ2V0aC9ldGhlcnMtY29yZSc7XG5pbXBvcnQgeyBFdmVudEZpbHRlciwgQ29udHJhY3RJbnRlcmZhY2UgfSBmcm9tICdAZXRoZXJzcHJvamVjdC9jb250cmFjdHMnO1xuaW1wb3J0IHsgTG9nIH0gZnJvbSAnQGV0aGVyc3Byb2plY3QvYWJzdHJhY3QtcHJvdmlkZXInO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgc2hhcmVSZXBsYXksIG1hcCwgZnJvbSwgc2Nhbiwgc3RhcnRXaXRoLCBjb21iaW5lTGF0ZXN0LCBmaW5hbGl6ZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZnJvbUV0aEV2ZW50IH0gZnJvbSAnLi9ldmVudHMnO1xuaW1wb3J0IHsgaW5qZWN0LCBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHR5cGUgeyBTaWduZXIgfSBmcm9tICdAZXRoZXJzcHJvamVjdC9hYnN0cmFjdC1zaWduZXInO1xuaW1wb3J0IHR5cGUgeyBFdmVudCB9IGZyb20gJ0BldGhlcnNwcm9qZWN0L2NvbnRyYWN0cyc7XG5pbXBvcnQgdHlwZSB7IFByb3ZpZGVyIH0gZnJvbSBcIkBldGhlcnNwcm9qZWN0L3Byb3ZpZGVyc1wiO1xuaW1wb3J0IHR5cGUgeyBCeXRlc0xpa2UgfSBmcm9tICdAZXRoZXJzcHJvamVjdC9ieXRlcyc7XG5cbmZ1bmN0aW9uIGdldEV2ZW50VGFnKGZpbHRlcjogRXZlbnRGaWx0ZXIpOiBzdHJpbmcge1xuICBjb25zdCBlbXB0eVRvcGljcyA9ICFmaWx0ZXIudG9waWNzIHx8ICFmaWx0ZXIudG9waWNzLmxlbmd0aDtcbiAgaWYgKGZpbHRlci5hZGRyZXNzICYmIGVtcHR5VG9waWNzKSByZXR1cm4gJyonO1xuXG4gIGNvbnN0IGFkZHJlc3MgPSBmaWx0ZXIuYWRkcmVzcyA/PyAnKic7XG4gIGNvbnN0IHRvcGljcyA9IChmaWx0ZXIudG9waWNzID8/IFtdKS5tYXAoKHRvcGljKSA9PlxuICAgIEFycmF5LmlzQXJyYXkodG9waWMpID8gdG9waWMuam9pbignfCcpIDogdG9waWNcbiAgKTtcbiAgcmV0dXJuIGAke2FkZHJlc3N9OiR7dG9waWNzfWA7XG59XG5cbmZ1bmN0aW9uIGZsYXR0ZW5FdmVudHMoZXZlbnRzOiBFdmVudFtdKSB7XG4gIGNvbnN0IHJlY29yZDogUmVjb3JkPHN0cmluZywgRXZlbnQ+ID0ge307XG4gIGZvciAoY29uc3QgZXZlbnQgb2YgZXZlbnRzKSB7XG4gICAgcmVjb3JkW2V2ZW50LnRyYW5zYWN0aW9uSGFzaF0gPSBldmVudDtcbiAgfVxuICByZXR1cm4gT2JqZWN0LnZhbHVlcyhyZWNvcmQpO1xufVxuXG5leHBvcnQgY2xhc3MgTmdDb250cmFjdDxcbiAgRXZlbnRzIGV4dGVuZHMgQ29udHJhY3RFdmVudHM8RXZlbnRLZXlzLCBGaWx0ZXJLZXlzPixcbiAgRXZlbnRLZXlzIGV4dGVuZHMgRXh0cmFjdDxrZXlvZiBFdmVudHNbJ2V2ZW50cyddLCBzdHJpbmc+ID0gRXh0cmFjdDxrZXlvZiBFdmVudHNbJ2V2ZW50cyddLCBzdHJpbmc+LFxuICBGaWx0ZXJLZXlzIGV4dGVuZHMgRXh0cmFjdDxrZXlvZiBFdmVudHNbJ2ZpbHRlcnMnXSwgc3RyaW5nPiA9IEV4dHJhY3Q8a2V5b2YgRXZlbnRzWydmaWx0ZXJzJ10sIHN0cmluZz4sXG4+IGV4dGVuZHMgRXRoZXJzQ29udHJhY3Q8RXZlbnRzLCBFdmVudEtleXMsIEZpbHRlcktleXM+IHsgIFxuXG4gIHByaXZhdGUgbmdab25lOiBOZ1pvbmU7XG4gIHByaXZhdGUgX2V2ZW50czogUmVjb3JkPHN0cmluZywgT2JzZXJ2YWJsZTxhbnk+PiA9IHt9O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGFkZHJlc3M6IHN0cmluZyxcbiAgICBhYmk6IENvbnRyYWN0SW50ZXJmYWNlLFxuICAgIHNpZ25lcj86IFByb3ZpZGVyIHwgU2lnbmVyLFxuICAgIG5nWm9uZT86IE5nWm9uZSxcbiAgKSB7XG4gICAgc3VwZXIoYWRkcmVzcywgYWJpLCBzaWduZXIpO1xuICAgIHRoaXMubmdab25lID0gbmdab25lID8/IGluamVjdChOZ1pvbmUpO1xuICB9XG5cbiAgLyoqIFRyYW5zZm9ybSBldmVudCBuYW1lIGludG8gYW4gRXZlbnRGaWx0ZXIgKi9cbiAgcHJpdmF0ZSBnZXRFdmVudEZpbHRlcihuYW1lOiBzdHJpbmcpOiBFdmVudEZpbHRlciB7XG4gICAgaWYgKG5hbWUgPT09ICdlcnJvcicpXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1wiZXJyb3JcIiBldmVudCBpcyBub3QgaW1wbGVtZW50ZWQgeWV0Jyk7XG4gICAgaWYgKG5hbWUgPT09ICdldmVudCcpXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1wiZXZlbnRcIiBldmVudCBpcyBub3QgaW1wbGVtZW50ZWQgeWV0Jyk7XG4gICAgaWYgKG5hbWUgPT09ICcqJykgdGhyb3cgbmV3IEVycm9yKCdcIipcIiBldmVudCBpcyBub3QgaW1wbGVtZW50ZWQgeWV0Jyk7XG4gICAgY29uc3QgZnJhZ21lbnQgPSB0aGlzLmludGVyZmFjZS5nZXRFdmVudChuYW1lKTtcbiAgICBjb25zdCB0b3BpYyA9IHRoaXMuaW50ZXJmYWNlLmdldEV2ZW50VG9waWMoZnJhZ21lbnQpO1xuICAgIHJldHVybiB7IGFkZHJlc3M6IHRoaXMuYWRkcmVzcywgdG9waWNzOiBbdG9waWNdIH07XG4gIH1cblxuICBwcml2YXRlIHdyYXBFdmVudChsb2c6IExvZyk6IFR5cGVkRXZlbnQ8RXZlbnRzLCBGaWx0ZXJLZXlzPiB7XG4gICAgY29uc3QgeyBuYW1lLCBzaWduYXR1cmUsIGFyZ3MsIGV2ZW50RnJhZ21lbnQgfSA9IHRoaXMuaW50ZXJmYWNlLnBhcnNlTG9nKGxvZyk7XG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLmxvZyxcbiAgICAgIGdldEJsb2NrOiAoKSA9PiB0aGlzLnByb3ZpZGVyLmdldEJsb2NrKGxvZy5ibG9ja0hhc2gpLFxuICAgICAgZ2V0VHJhbnNhY3Rpb246ICgpID0+IHRoaXMucHJvdmlkZXIuZ2V0VHJhbnNhY3Rpb24obG9nLnRyYW5zYWN0aW9uSGFzaCksXG4gICAgICBnZXRUcmFuc2FjdGlvblJlY2VpcHQ6ICgpID0+IHRoaXMucHJvdmlkZXIuZ2V0VHJhbnNhY3Rpb25SZWNlaXB0KGxvZy50cmFuc2FjdGlvbkhhc2gpLFxuICAgICAgZGVjb2RlOiAoZGF0YTogQnl0ZXNMaWtlLCB0b3BpY3M/OiBBcnJheTxzdHJpbmc+KSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmludGVyZmFjZS5kZWNvZGVFdmVudExvZyhldmVudEZyYWdtZW50LCBkYXRhLCB0b3BpY3MpO1xuICAgICAgfSxcbiAgICAgIGV2ZW50OiBuYW1lLFxuICAgICAgZXZlbnRTaWduYXR1cmU6IHNpZ25hdHVyZSxcbiAgICAgIGFyZ3M6IGFyZ3NcbiAgICB9IGFzIFR5cGVkRXZlbnQ8RXZlbnRzLCBGaWx0ZXJLZXlzPlxuICB9XG5cbiAgLyoqXG4gICAqIExpc3RlbiBvbiB0aGUgY2hhbmdlcyBvZiBhbiBldmVudCwgc3RhcnRpbmcgd2l0aCB0aGUgY3VycmVudCBzdGF0ZVxuICAgKiBAcGFyYW0gZXZlbnQgVGhlIGV2ZW50IGZpbHRlclxuICAgKi9cbiAgZnJvbTxLIGV4dGVuZHMgRmlsdGVyS2V5cz4oZXZlbnQ6IFR5cGVkRmlsdGVyPEs+IHwgSyk6IE9ic2VydmFibGU8VHlwZWRFdmVudDxFdmVudHMsIEs+W10+IHtcbiAgICBpZiAoIXRoaXMucHJvdmlkZXIpIHRocm93IG5ldyBFcnJvcignUHJvdmlkZXIgcmVxdWlyZWQgZm9yIGV2ZW50Jyk7XG4gICAgY29uc3QgZXZlbnRGaWx0ZXIgPSB0eXBlb2YgZXZlbnQgPT09ICdzdHJpbmcnXG4gICAgICA/IHRoaXMuZ2V0RXZlbnRGaWx0ZXIoZXZlbnQpXG4gICAgICA6IGV2ZW50O1xuICAgIGNvbnN0IHRvcGljID0gZXZlbnRGaWx0ZXIudG9waWNzPy5bMF07XG4gICAgaWYgKHR5cGVvZiB0b3BpYyAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcignSW52YWxpZCB0b3BpYycpO1xuXG4gICAgY29uc3QgdGFnID0gZ2V0RXZlbnRUYWcoZXZlbnRGaWx0ZXIpO1xuICAgIGlmICghdGhpcy5fZXZlbnRzW3RhZ10pIHtcbiAgICAgIGNvbnN0IGluaXRpYWwgPSB0aGlzLnF1ZXJ5RmlsdGVyKGV2ZW50RmlsdGVyKTtcbiAgICAgIGNvbnN0IGxpc3RlbmVyID0gZnJvbUV0aEV2ZW50PExvZz4oXG4gICAgICAgIHRoaXMucHJvdmlkZXIsXG4gICAgICAgIHRoaXMubmdab25lLFxuICAgICAgICBldmVudEZpbHRlclxuICAgICAgKS5waXBlKFxuICAgICAgICBtYXAobG9nID0+IHRoaXMud3JhcEV2ZW50KGxvZykpLFxuICAgICAgICBzY2FuKChhY2MsIHZhbHVlKSA9PiBhY2MuY29uY2F0KHZhbHVlKSwgW10gYXMgVHlwZWRFdmVudDxFdmVudHMsIEZpbHRlcktleXM+W10pLFxuICAgICAgICBzdGFydFdpdGgoW10gYXMgVHlwZWRFdmVudDxFdmVudHMsIEZpbHRlcktleXM+W10pXG4gICAgICApO1xuXG4gICAgICB0aGlzLl9ldmVudHNbdGFnXSA9IGNvbWJpbmVMYXRlc3QoW1xuICAgICAgICBmcm9tKGluaXRpYWwpLFxuICAgICAgICBsaXN0ZW5lcixcbiAgICAgIF0pLnBpcGUoXG4gICAgICAgIG1hcCgoW2V2ZW50cywgbGFzdF0pID0+IFsuLi5ldmVudHMsIC4uLmxhc3RdKSxcbiAgICAgICAgbWFwKGZsYXR0ZW5FdmVudHMpLCAvLyByZW1vdmUgZHVwbGljYXRlZCAoZXZlbnRzIHNlZW1zIHRvIGhhdmUgYSBjYWNoZSBvZiAyIHNvbWVob3cuLi4pXG4gICAgICAgIGZpbmFsaXplKCgpID0+IGRlbGV0ZSB0aGlzLl9ldmVudHNbdGFnXSksIC8vIHJlbW92ZSBjYWNoZSB3aGVuIG5vIHN1YnNjcmliZXIgcmVtYWluc1xuICAgICAgICBzaGFyZVJlcGxheSh7IHJlZkNvdW50OiB0cnVlLCBidWZmZXJTaXplOiAxIH0pLFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX2V2ZW50c1t0YWddO1xuICB9XG59XG4iXX0=